<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <style>
        body {
        background-color: #775c21;
        }
      </style>
</head>
<body onload="getAktie()">
    <h1>Aktiedata i realtid</h1>
    <div id="datat"></div>
    <br>
    <canvas id="myCanvas" width="1250" height="600" style="border:1px solid #000000">
    </canvas>  

<script>
    //setInterval('getISS()', 3000)
    
    var arr;
    //const api_url = 'https://www.alphavantage.co/query?function=TIME_SERIES_INTRADAY&symbol=STO:LUC&interval=5min&outputsize=compact&apikey=PI94RGOINPZE8JOZ'
    const api_url = 'https://www.alphavantage.co/query?function=TIME_SERIES_DAILY&symbol=STO:LUC&outputsize=full&apikey=PI94RGOINPZE8JOZ'
    var skrivUt = [];  var open=[],high =[],low=[],close=[], aktivArrayStorlek = 130,range=[];

    async function getAktie(){
        const response = await fetch(api_url);
        const data = await response.json();
        console.log(data);
        arr = Object.entries(data["Time Series (Daily)"]);
        for (i = 0;i < arr.length; i++){
            var tid = (arr[i][0]);
            open[i] = parseFloat(arr[i][1]["1. open"]);
            high[i] = parseFloat(arr[i][1]["2. high"]);    
            low[i] = parseFloat(arr[i][1]["3. low"]);
            close[i] = parseFloat(arr[i][1]["4. close"]); 

            //skrivUt [i]="Tid "+tid+" Open: "+open+" High "+high+" Low "+low+" Close "+close+" ";
            
            }
            range = raknaUtRange();
            ritaUtCandleSticks()
    }
    function raknaUtRange(){
        var aktivaArraynHigh =[],aktivaArraynLow=[],storsta,minsta,range=[];
        for (i=0; i<aktivArrayStorlek;i++){
        aktivaArraynHigh[i]=high[i];aktivaArraynLow[i]=low[i]}
        storsta=Math.max.apply(null, aktivaArraynHigh);
        minsta=Math.min.apply(null, aktivaArraynLow);
        console.log(storsta+" "+minsta);
        range[0] = storsta - minsta;
        range[1] = storsta;
        range[2] = minsta;
        range[3] = ((range[1]*100)/range[0])/100;
        return range;
    }    
    function ritaUtCandleSticks(){
    var canvas = document.getElementById("myCanvas");
    var ctx = canvas.getContext("2d");
    var aktivArrayStorlek = 130;
    var bredd=6;
    var ch=500;
    var avstand=9;
    var hojd;
    var utr;  
    //range[0] = rangen mellan högsta och lägsta. range[1] = hogsta high i arrayn range [2] = lägsta i arrayn
    hojd = ch/range[0];
    ch *= range[3]+range[3]*0.05;//range[3] = den procentuella skillnaden mellan range och högsta
    ctx.clearRect(0, 0, window.innerWidth,window.innerHeight);
    ctx.fillStyle = 'rgb(255, 236, 179)';
    ctx.fillRect(0,0,window.innerWidth,window.innerHeight);

    for (i = aktivArrayStorlek; i > 0 ; i-- ){						
        utr=aktivArrayStorlek-i;
    
    if (open[utr]>close[utr]) 	{				//BEARcandle
            //Rita kropp
            ctx.lineWidth=1;
            ctx.fillStyle = "#FF0000";
            ctx.fillRect(i*avstand+bredd,ch-open[utr]*hojd,bredd,open[utr]*hojd-close[utr]*hojd);			
            //Rita veke ovanför
            ctx.beginPath();
            ctx.lineWidth=2;
            ctx.fillStyle ="#000000";
            ctx.moveTo(i*avstand+bredd+(bredd/2),ch-open[utr]*hojd);//startpunkt x,y
            ctx.lineTo((i*avstand+bredd)+(bredd/2),(ch-(open[utr]*hojd))+(ch-(high[utr]*hojd))-(ch-(open[utr]*hojd)));
            ctx.stroke();
            //Rita veke under
            ctx.beginPath();
            ctx.lineWidth=2;
            ctx.fillStyle ="#000000";
            ctx.moveTo(i*avstand+bredd+(bredd/2),ch-low[utr]*hojd);
            ctx.lineTo(i*avstand+bredd+(bredd/2),ch-close[utr]*hojd);
            ctx.stroke();
    }
    if (close[utr]>open[utr]) 	{				//BULLcandle
    
        //Rita kropp
        ctx.lineWidth=1;
        ctx.fillStyle = "#009900";
        ctx.fillRect(i*avstand+bredd,ch-(close[utr]*hojd),bredd,close[utr]*hojd-open[utr]*hojd);//(startpunkt x,y),bredd,höjd						
        //veke ovanför
        ctx.beginPath();
        ctx.lineWidth=2;
        ctx.fillStyle ="#000000";
        ctx.moveTo(i*avstand+bredd+(bredd/2),ch-(close[utr]*hojd));
        ctx.lineTo(i*avstand+bredd+(bredd/2),ch-(close[utr]*hojd)+(ch-(high[utr]*hojd))-(ch-(close[utr]*hojd)));
        ctx.stroke();
        //veke under
        ctx.beginPath();
        ctx.fillStyle ="#000000";
        ctx.lineWidth=2;
        ctx.moveTo(i*avstand+bredd+(bredd/2),ch-open[utr]*hojd);
        ctx.lineTo(i*avstand+bredd+(bredd/2),ch-low[utr]*hojd);
        ctx.stroke();
    }
    if (close[utr]==open[utr]) 	{				//Doji
    
        //Rita kropp
        ctx.lineWidth=1;
        ctx.fillStyle ="#000000";
        ctx.moveTo(i*avstand+bredd,ch-close[utr]*hojd);
        ctx.lineTo(i*avstand+bredd+bredd,ch-close[utr]*hojd);
        ctx.stroke();
        //veke ovanför
        ctx.beginPath();
        ctx.lineWidth=2;
        ctx.fillStyle ="#000000";
        ctx.moveTo(i*avstand+bredd+(bredd/2),ch-close[utr]*hojd);
        ctx.lineTo(i*avstand+bredd+(bredd/2),ch-(close[utr]*hojd)+(ch-(high[utr]*hojd))-(ch-(close[utr]*hojd)));
        ctx.stroke();
        //veke under
        ctx.beginPath();
        ctx.lineWidth=2;
        ctx.fillStyle ="#000000";
        ctx.moveTo(i*avstand+bredd+(bredd/2),ch-open[utr]*hojd);
        ctx.lineTo(i*avstand+bredd+(bredd/2),ch-low[utr]*hojd);
        ctx.stroke();				                               
    }
    } 
    }
</script>  

</body>
</html>


